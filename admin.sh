#!/bin/bash

# =============================================================================
# 색상 및 스타일 정의
# =============================================================================
BOLD=$(tput bold)
NORMAL=$(tput sgr0)
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
GREEN='\033[1;32m'
NC='\033[0m' # 색상 초기화

# =============================================================================
# 경로 설정
# =============================================================================
USER_NAME=$(whoami)
JSON_FILE="/home/$USER_NAME/palworld-wine/game/Pal/Binaries/Win64/PalDefender/Config.json"
RESTART_SCRIPT="/home/$USER_NAME/restart.sh"

# =============================================================================
# 함수 정의
# =============================================================================

# 오류 처리 함수
handle_error() {
    echo -e "\n${RED}${BOLD}[ERROR] $1${NC}${NORMAL}" >&2
    exit 1
}

# =============================================================================
# 시작 메시지
# =============================================================================
echo -e "\n${BLUE}${BOLD}======================================================"
echo -e " 팰월드 서버 운영자 IP 추가 도구"
echo -e "======================================================${NC}"

# =============================================================================
# jq 설치 확인 및 설치
# =============================================================================
if ! command -v jq &> /dev/null; then
    echo -e "\n${YELLOW}${BOLD}⚠ jq가 설치되어 있지 않습니다. 설치를 진행합니다...${NC}"
    sudo apt update && sudo apt install -y jq || handle_error "jq 설치 실패"
    echo -e "${GREEN}✓ jq 설치가 완료되었습니다.${NC}"
fi

# =============================================================================
# 사용자 입력 받기
# =============================================================================
echo -e "\n${YELLOW}${BOLD}■ 추가할 운영자 IP 주소를 입력하세요${NC}"
echo -e "  ${BLUE}※ 형식: 123.456.789.123${NC}"
echo -ne "\n${YELLOW}${BOLD}▶ IP 주소: ${NC}"
read -r NEW_IP

# 입력 유효성 검사
if [[ ! $NEW_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    handle_error "잘못된 IP 형식입니다. 유효한 IP 주소를 입력해주세요."
fi

# =============================================================================
# JSON 파일 존재 여부 확인
# =============================================================================
if [ ! -f "$JSON_FILE" ]; then
    handle_error "Config.json 파일을 찾을 수 없습니다: $JSON_FILE"
fi

# =============================================================================
# IP 추가 작업
# =============================================================================
echo -e "\n${BLUE}${BOLD}■ 운영자 IP 추가 중...${NC}"

# jq를 사용해 조건에 따라 삽입
jq --arg new_ip "$NEW_IP" '
  .adminIPs |= (
    (index("127.0.0.1") as $i |
      .[:$i+1] + [$new_ip] + .[$i+1:]
    ) // (. + [$new_ip])
  )
' "$JSON_FILE" > tmp.json && mv tmp.json "$JSON_FILE" || handle_error "IP 추가 실패"

echo -e "${GREEN}✓ 운영자 IP 주소가 성공적으로 추가되었습니다: $NEW_IP${NC}"

# =============================================================================
# 서버 재시작
# =============================================================================
echo -e "\n${BLUE}${BOLD}■ 서버 재시작 중...${NC}"

if [ ! -f "$RESTART_SCRIPT" ]; then
    handle_error "재시작 스크립트를 찾을 수 없습니다: $RESTART_SCRIPT"
fi

bash "$RESTART_SCRIPT" || handle_error "서버 재시작 실패"

# =============================================================================
# 완료 메시지
# =============================================================================
echo -e "\n${GREEN}${BOLD}======================================================"
echo -e "  작업이 성공적으로 완료되었습니다!"
echo -e "======================================================"
echo -e "  추가된 운영자 IP: $NEW_IP${NC}"
echo -e "${GREEN}${BOLD}======================================================${NC}\n"
